#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# 1. Code Quality (MUST pass)
echo "\nğŸ“ Checking code style and types..."
npm run lint
if [ $? -ne 0 ]; then
  echo "âŒ Linting failed - commit blocked"
  exit 1
fi

npm run type-check
if [ $? -ne 0 ]; then
  echo "âŒ Type checking failed - commit blocked"
  exit 1
fi

# 2. Core Functionality Tests (MUST pass - excluding security tests)
echo "\nğŸ§ª Running core functionality tests..."
cd apps/api && npm run test -- --testPathPattern="(auth|admin\.service|users\.service)\.test\.(ts|js)$"
if [ $? -ne 0 ]; then
  echo "âŒ Core functionality tests failed - commit blocked"
  cd ../..
  exit 1
fi
cd ../..

# 3. Coverage Validation (MUST pass)
echo "\nğŸ“Š Validating code coverage..."
cd apps/api && node scripts/check-coverage.js
coverage_result=$?
cd ../..

if [ $coverage_result -ne 0 ]; then
  echo "âŒ Coverage validation failed - commit blocked"
  exit 1
fi

# 4. Security Tests (warnings only - don't block)
echo "\nğŸ›¡ï¸  Running security tests (warnings only)..."
cd apps/api && npm run test -- --testPathPattern="users\.routes\.security\.test\.(ts|js)$" || echo "âš ï¸  Security tests failed - please review before pushing to production"
cd ../..

echo "\nâœ… Pre-commit checks completed!"
echo "ğŸ’¡ Run 'npm run test:integration' to check full integration tests"
echo "ğŸš€ Safe to commit!"