# Story 1.5: Configure Foundational CI/CD Deployment

## Status
Approved

## Story
**As a** Developer,
**I want** to configure automated deployment pipelines for both frontend and backend applications,
**so that** we have a reliable, automated deployment process to production environments.

## Acceptance Criteria
1. The CI/CD pipeline automatically deploys the Next.js frontend to Vercel on successful builds
2. The CI/CD pipeline automatically deploys the backend API service to Google Cloud Run on successful builds
3. Deployment includes proper environment variable management and secrets handling
4. The deployed health check endpoint is accessible and returns `200 OK` status
5. Deployment pipeline includes rollback capability for failed deployments
6. All deployments are triggered automatically on pushes to the main branch after passing CI checks

## Tasks / Subtasks
- [ ] Task 1: Configure Vercel Frontend Deployment (AC: 1)
  - [ ] Set up Vercel project and connect to GitHub repository
  - [ ] Configure build settings and environment variables in Vercel
- [ ] Task 2: Configure Google Cloud Run Backend Deployment (AC: 2)
  - [ ] Create Dockerfile for Express.js app in apps/api/
  - [ ] Set up Cloud Build for automated container builds
  - [ ] Set up Cloud Run service deployment configuration
- [ ] Task 3: Environment Management & Secrets (AC: 3)
  - [ ] Create GCP Service Account for deployment with necessary IAM roles (e.g., Cloud Run Admin, Secret Manager Accessor)
  - [ ] Securely store the Service Account JSON key as a GitHub Actions Secret
  - [ ] Set up Google Secret Manager for production secrets
  - [ ] Configure environment variables for different deployment stages
- [ ] Task 4: Health Check Verification (AC: 4)
  - [ ] Add a deployment verification step in the GitHub Actions workflow to curl the deployed /health endpoint and check for a 200 OK response
- [ ] Task 5: Deployment Pipeline Robustness (AC: 5, 6)
  - [ ] Configure the deployment job to only trigger after the CI checks job (lint, test) from Story 1.1 succeeds on the main branch
  - [ ] Set up basic rollback mechanism for failed deployments

## Dev Notes

### Previous Story Dependencies
[Source: Story 1.1] 
This story requires Story 1.1 (Project Initialization & Foundational CI) to be completed first. The basic project structure, CI pipeline, and health check endpoint must be in place.

### Architecture Context
[Source: architecture/2-high-level-architecture.md]
- **Frontend Deployment:** Vercel hosting for Next.js PWA for optimal performance
- **Backend Deployment:** Google Cloud Run for latency-sensitive APIs to eliminate cold-start risks
- **Hybrid Architecture:** Frontend on Vercel, backend on Google Cloud Platform (GCP)

### Platform Requirements
[Source: architecture/2-high-level-architecture.md]
**Key GCP Services for Deployment:**
- **Cloud Run:** For synchronous, user-facing serverless APIs (Auth, Courses, Practice, etc.)
- **Cloud Build:** For automated container builds and deployments
- **API Gateway:** To manage, secure, and route all API requests (future story)
- **Google Secret Manager:** For secure secrets and environment variable management

### Container Configuration
[Source: architecture/7-unified-project-structure.md]
- **Dockerfile Location:** apps/api/Dockerfile for Cloud Run container definition
- **Build Context:** Must build from monorepo root to access shared packages
- **Port Configuration:** Cloud Run expects containerized apps to listen on PORT environment variable

### Security Requirements
[Source: architecture/6-security.md]
- **Secrets Management:** Google Secret Manager for production; .env files for local development
- **Authentication:** Service account authentication for Cloud Build to deploy to Cloud Run
- **HTTPS:** TLS 1.2+ for data in transit (automatically handled by Vercel and Cloud Run)
- **Access Control:** Proper IAM roles for deployment pipeline

### Monitoring & Observability
[Source: architecture/9-error-handling-and-observability.md]
- **Health Checks:** Cloud Run service must respond to health check probes
- **Logging:** Structured (JSON) logging in Google Cloud Logging
- **Monitoring:** Basic uptime and error rate monitoring using Google Cloud Monitoring

### Testing
- **Deployment Verification:** Automated verification that deployed services are accessible
- **Health Check Testing:** Verify /health endpoint returns 200 OK after deployment
- **Rollback Testing:** Verify rollback mechanism works correctly
- **Environment Testing:** Test environment variable propagation in deployed environments

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-06 | 1.0 | Initial deployment story creation | Bob, SM |

## Dev Agent Record

### Agent Model Used
[To be populated by Dev Agent]

### Debug Log References
[To be populated by Dev Agent]

### Completion Notes List
[To be populated by Dev Agent]

### File List
[To be populated by Dev Agent]

## QA Results
[To be populated by QA Agent]