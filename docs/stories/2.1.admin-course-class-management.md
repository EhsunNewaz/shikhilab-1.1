# Story 2.1: Admin Course & Class Management

## Status
Approved

## Story
**As an** Admin,
**I want** to create a course structure by defining a sequence of classes,
**so that** I can organize the curriculum for a new batch of students.

## Acceptance Criteria
1. Data models for `Course` and `Class` are created. A `Class` must belong to a `Course`.
2. The `Class` model must include a `title`, `orderNumber`, and `releaseDate`.
3. The admin panel has a new 'Course Management' section where an admin can create courses and add classes to them.
4. An admin can assign enrolled students to a specific course.

## Tasks / Subtasks
- [ ] Task 1: Verify Course and Class Data Models (AC: 1, 2)
  - [ ] Review existing database schema for `courses` and `classes` tables in Cloud SQL
  - [ ] Verify data model alignment with architecture specifications
  - [ ] Create TypeScript types and Zod validation schemas in `packages/shared/`
  - [ ] Export types for frontend and backend consumption
- [ ] Task 2: Implement Course Management Backend APIs (AC: 1, 3, 4)
  - [ ] Create `/courses` service module following architecture structure `apps/api/src/courses/`
  - [ ] Implement `courses.routes.ts` with Express router definitions for CRUD operations
  - [ ] Implement `courses.service.ts` with business logic for course and class management
  - [ ] Implement `courses.validators.ts` with Zod validation schemas for request/response
  - [ ] Add endpoints: POST /courses, GET /courses, POST /courses/{id}/classes, GET /courses/{id}/classes
  - [ ] Add endpoint: POST /courses/{id}/enrollments for student assignment
  - [ ] Add admin-only endpoint: GET /admin/users to fetch list of all students for enrollment assignment
- [ ] Task 3: Create Admin Course Management Frontend (AC: 3, 4)
  - [ ] Create admin route group structure in `apps/web/app/(auth)/admin/`
  - [ ] Create course management page at `apps/web/app/(auth)/admin/courses/page.tsx`
  - [ ] Build course creation form component with course title, description, capacity fields
  - [ ] Build class management interface for adding classes with title, order, release date
  - [ ] Implement student enrollment assignment interface
  - [ ] Use Radix UI components with Tailwind CSS styling per architecture standards
- [ ] Task 4: Testing Implementation (AC: 1, 2, 3, 4)
  - [ ] Create unit tests for course service business logic using Jest
  - [ ] Create API integration tests using Testcontainers for database validation
  - [ ] Create frontend component tests using React Testing Library
  - [ ] Ensure 80% test coverage as per architecture standards
  - [ ] Test file locations: `apps/api/__tests__/courses/` and `apps/web/__tests__/admin/courses/`

## Dev Notes

### Previous Story Dependencies
[Source: Story 1.5] 
This story builds on the deployment pipeline and authentication system established in previous stories. The admin authentication and database connections must be operational.

### Data Models Context
[Source: architecture/4-data-models.md]
**Course Model (Cloud SQL):**
- Table: `courses` with fields: `id` (UUID), `title` (VARCHAR 255), `description` (TEXT), `capacity` (INTEGER, default 50)
- Includes audit fields: `created_at`, `updated_at` (TIMESTAMPTZ)

**Class Model (Cloud SQL):**
- Table: `classes` with fields: `id` (UUID), `course_id` (FK to courses), `title` (VARCHAR 255), `order_number` (INTEGER), `release_date` (DATE)  
- Includes audit fields: `created_at`, `updated_at` (TIMESTAMPTZ)
- Unique constraint: `(course_id, order_number)` for proper ordering
- Cascade delete when parent course is deleted

**Course Enrollments Model (Cloud SQL):**
- Table: `course_enrollments` with composite primary key: `(user_id, course_id)`
- Fields: `user_id` (FK to users), `course_id` (FK to courses), `enrolled_at` (TIMESTAMPTZ)
- Cascade delete when user or course is deleted

**Enrollments Table Schema (Corrected from Story 1.2):**
```sql
CREATE TABLE enrollments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    course_id UUID NOT NULL REFERENCES courses(id) ON DELETE CASCADE,
    full_name VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL,
    transaction_id VARCHAR(255) NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

### API Architecture Context
[Source: architecture/5-api-specification.md]
**API Endpoint Structure:**
- Base URL: `https://api.shikhilab.com/v1`
- Authentication: Bearer JWT tokens required for admin endpoints
- Security: Rate limiting and CORS policies must be implemented
- Response format: JSON with consistent error handling patterns

**Required Course Management Endpoints:**
- `POST /courses` - Create new course
- `GET /courses` - List all courses  
- `POST /courses/{id}/classes` - Add class to course
- `GET /courses/{id}/classes` - Get course classes
- `POST /courses/{id}/enrollments` - Assign students to course
- `GET /admin/users` - Fetch list of all students (admin-only, for enrollment assignment UI)

### Project Structure Context
[Source: architecture/7-unified-project-structure.md]
**Backend Service Structure:**
- Location: `apps/api/src/courses/`
- Files: `index.ts` (entry), `courses.routes.ts` (Express routes), `courses.service.ts` (business logic), `courses.validators.ts` (Zod schemas)
- Database connection: Use existing Cloud SQL connection patterns established in auth service

**Frontend Structure:**
- Admin routes: `apps/web/app/(auth)/admin/` route group for authenticated admin pages
- Shared components: `apps/web/components/` for reusable admin UI components
- Types location: `packages/shared/` for TypeScript interfaces and Zod schemas

**Shared Packages:**
- Types: `packages/shared/types/` for Course and Class TypeScript interfaces
- Validation: `packages/shared/schemas/` for Zod validation schemas
- Config: `packages/config/` for shared ESLint and TypeScript configurations

### Tech Stack Requirements
[Source: architecture/3-tech-stack.md]
**Backend Technology:**
- Node.js 20.11.1 LTS with Express.js 4.19.2
- TypeScript 5.4.5 for type safety
- Database: Google Cloud SQL with existing connection patterns

**Frontend Technology:**
- Next.js 14.2.3 with App Router structure
- UI Components: Radix UI (~1.0.0) + Tailwind CSS 3.4.1
- State Management: Zustand 4.5.2 for admin state if needed
- Default to Server Components; use `'use client'` only when client interactivity required

### Security Requirements
[Source: architecture/6-security.md]
**Authentication & Authorization:**
- JWT Bearer tokens for API authentication
- Admin role verification for course management endpoints
- Secure HTTP-only cookies for refresh tokens
- No sensitive data in localStorage

**API Security:**
- Rate limiting on course creation endpoints
- CORS policy restricting to frontend domain
- Input validation using Zod schemas
- SQL injection prevention through parameterized queries

### Testing Requirements
[Source: architecture/8-test-strategy-and-standards.md]
**Test Framework:** Jest (~29.7.0) with React Testing Library for frontend
**Test Coverage:** Maintain 80% coverage following Test Pyramid model
**Test File Locations:**
- Backend: `apps/api/__tests__/courses/` for service and route tests
- Frontend: `apps/web/__tests__/admin/courses/` for component tests
- Integration: Use Testcontainers for real database testing in CI

**Testing Approach:**
- Unit tests for business logic in `courses.service.ts`
- Integration tests for API endpoints with real Cloud SQL database
- Component tests for admin UI using React Testing Library
- Accessibility tests with jest-axe (WCAG 2.1 AA compliance)

### Error Handling Context
No specific error handling patterns found in architecture docs. Follow existing patterns established in authentication service.

## Testing
**Test Framework:** Jest (~29.7.0) for all testing with React Testing Library for frontend components
**Test File Locations:**
- `apps/api/__tests__/courses/` - Backend service and API route tests
- `apps/web/__tests__/admin/courses/` - Frontend component tests
- Use Testcontainers pattern for integration tests with real Cloud SQL database

**Coverage Requirements:**
- Maintain 80% test coverage per architecture standards
- Follow Test Pyramid model: majority unit tests, some integration tests
- Include accessibility testing with jest-axe for WCAG 2.1 AA compliance

**Specific Test Requirements:**
- Course creation and validation logic
- Class ordering and release date constraints  
- Student enrollment assignment functionality
- Admin authentication and authorization flows
- Admin user list endpoint security and functionality

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-08 | 1.0 | Initial story creation with comprehensive architecture context | Bob, SM |
| 2025-08-08 | 1.1 | Added missing GET /admin/users endpoint and corrected enrollments schema | Sarah, PO |

## Dev Agent Record
[To be populated by Dev Agent]

## QA Results
[To be populated by QA Agent]